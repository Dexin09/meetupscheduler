<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Meetup Scheduler</title>
	<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
	<style>
		body { font-family: sans-serif; margin: 2rem; }
		#calendar { max-width: 700px; margin: 2rem auto; }
		.legend { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
		.legend span { display: inline-block; padding: 0.5rem; border-radius: 5px; font-size: 0.9rem; color: #fff; }
		.great { background-color: #30BF78; }
		.good { background-color: #60BF30; }
		.bad { background-color: #BFA730; }
		.awful { background-color: #BF3030; }
		.top-controls { text-align: center; margin-bottom: 1.5rem; }
		.top-controls input { padding: 0.5rem; width: 200px; margin-right: 1rem; }
		.top-controls button { padding: 0.5rem 1rem; }
	</style>
</head>
<body>
	<h1 style="text-align: center;">Meetup Scheduler</h1>
	<p style="text-align: center;">Enter your name and click on dates to mark your availability. Each click cycles through options.</p>
	<br><br>
	<div class="top-controls">
		<input type="text" id="nameInput" placeholder="Your name" />
		<button id="submitButton">Submit</button>
	</div>
	<div class="legend">
		<span class="great">‚úÖ Great</span>
		<span class="good">üëç Good</span>
		<span class="bad">‚ö†Ô∏è Bad</span>
		<span class="awful">‚ùå Awful</span>
	</div>
	<div id="calendar"></div>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
	<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
	<script>
	(async () => {
		// Supabase config
		const supabaseUrl = "https://gkpfmiomjxshpaodisxa.supabase.co";
		const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrcGZtaW9tanhzaHBhb2Rpc3hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MTIzNDgsImV4cCI6MjA2Njk4ODM0OH0.Svi1Xl88euqNn9osgXvbkPgb-iVrKo5mPCdIdWUP45g";
		const supabase = supabase.createClient(supabaseUrl, supabaseKey);
	
		// Get or create UUID
		let uuid = localStorage.getItem("user_uuid");
		if (!uuid) {
			uuid = crypto.randomUUID();
			localStorage.setItem("user_uuid", uuid);
		}
	
		// Read name from localStorage
		const nameInput = document.getElementById("nameInput");
		const storedName = localStorage.getItem("username");
		if (storedName) nameInput.value = storedName;
	
		// Read eventName from URL or default
		const urlParams = new URLSearchParams(window.location.search);
		const eventName = urlParams.get("event") || "DefaultEvent";
	
		// Status cycle & colors
		const statuses = ["great", "good", "bad", "awful", "clear"];
		const colors = {
			great: "#30BF78",
			good: "#60BF30",
			bad: "#BFA730",
			awful: "#BF3030"
		};
	
		// Track selected dates & statuses
		let selectedData = {};
	
		// Init FullCalendar
		const calendarEl = document.getElementById('calendar');
		const calendar = new FullCalendar.Calendar(calendarEl, {
			initialView: 'dayGridMonth',
			dateClick: function(info) {
				const dateStr = info.dateStr;
				let current = selectedData[dateStr];
				let nextStatus = statuses[0];
				if (current) {
					const idx = statuses.indexOf(current);
					nextStatus = statuses[(idx + 1) % statuses.length];
				}
				// Update
				if (nextStatus === "clear") {
					delete selectedData[dateStr];
					calendar.getEvents().filter(e=>e.id===dateStr).forEach(e=>e.remove());
				} else {
					selectedData[dateStr] = nextStatus;
					// Remove old, add new
					calendar.getEvents().filter(e=>e.id===dateStr).forEach(e=>e.remove());
					calendar.addEvent({
						id: dateStr,
						title: nextStatus,
						start: dateStr,
						color: colors[nextStatus]
					});
				}
			}
		});
		calendar.render();
	
		// Load existing data
		async function loadData() {
			const { data, error } = await supabase
				.from('availabilities')
				.select('*')
				.eq('uuid', uuid)
				.eq('eventName', eventName);
			if (error) {
				console.error("Load error:", error);
				return;
			}
			data.forEach(row => {
				selectedData[row.date] = row.status;
				calendar.addEvent({
					id: row.date,
					title: row.status,
					start: row.date,
					color: colors[row.status]
				});
			});
		}
		await loadData();
	
		// Submit handler
		document.getElementById("submitButton").addEventListener("click", async () => {
			const name = nameInput.value.trim();
			if (!name) {
				alert("Name cannot be empty!");
				return;
			}
			if (Object.keys(selectedData).length === 0) {
				alert("Select at least one date!");
				return;
			}
			localStorage.setItem("username", name);
			// Delete existing
			const { error: deleteError } = await supabase
				.from('availabilities')
				.delete()
				.eq('uuid', uuid)
				.eq('eventName', eventName);
			if (deleteError) {
				alert("Failed to clear old data: " + deleteError.message);
				return;
			}
			// Insert new
			const newRows = Object.entries(selectedData).map(([date, status]) => ({
				uuid, name, eventName, date, status
			}));
			const { error: insertError } = await supabase
				.from('availabilities')
				.insert(newRows);
			if (insertError) {
				alert("Failed to save data: " + insertError.message);
			} else {
				alert("Availability saved!");
			}
		});
	})();
	</script>
</body>
</html>
